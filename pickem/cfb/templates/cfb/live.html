{% extends 'cfb/base.html' %}
{% load static %}
{% load cfb_tags %}

{% block title %}Live Games - CFB Pick'em{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/live-updates.css' %}">
{% endblock %}

{% block content %}
    <div class="mb-6">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 class="text-4xl font-bold mb-2">
                <i class="fas fa-play-circle text-primary mr-2"></i>
                Live Games
            </h1>
            <div class="flex items-center gap-3">
                <p class="text-base-content/70">Track your picks in real-time</p>
                <!-- Live Status Indicator -->
                <div id="live-status-indicator" class="text-xs">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
        
        <div class="flex flex-col md:flex-row gap-2 md:gap-3">
            <!-- League Selector -->
            {% if user_leagues.count > 1 %}
            <div class="form-control w-full md:w-auto">
                <select class="select select-bordered select-primary" onchange="window.location.href='?league_id=' + this.value">
                    {% for league in user_leagues %}
                    <option value="{{ league.id }}" {% if league.id == current_league.id %}selected{% endif %}>
                        {{ league.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% elif current_league %}
            <div class="badge badge-primary badge-lg">{{ current_league.name }}</div>
            {% endif %}
            
            <!-- Update Scores Button -->
            {% if current_league %}
            <form method="POST" action="{% url 'update_live_scores' %}" class="inline-block">
                {% csrf_token %}
                <input type="hidden" name="league_id" value="{{ current_league.id }}">
                <button type="submit" class="btn btn-secondary btn-sm md:btn-md">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Update Scores
                </button>
            </form>
            {% endif %}
        </div>
    </div>
</div>

{% if picks_with_sections %}
    <div class="grid grid-cols-1 gap-3" id="games-container">
        {% for item in picks_with_sections %}
            {% if item.is_section %}
                {# Section header #}
                <div class="flex items-center gap-3 {% if not forloop.first %}mt-6{% else %}mt-2{% endif %} mb-2">
                    {% if item.status == 'live' %}
                        <div class="badge badge-warning badge-lg gap-2">
                            <i class="fas fa-circle animate-pulse"></i>
                            LIVE GAMES
                        </div>
                    {% elif item.status == 'final' %}
                        <div class="badge badge-success badge-lg gap-2">
                            <i class="fas fa-check-circle"></i>
                            FINAL GAMES
                        </div>
                    {% else %}
                        <div class="badge badge-info badge-lg gap-2">
                            <i class="fas fa-clock"></i>
                            UPCOMING GAMES
                        </div>
                    {% endif %}
                    <div class="flex-1 h-px bg-base-300"></div>
                </div>
            {% else %}
                {# Game card #}
                {% with p=item.pick lg=item.league_game %}
                <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow" 
             data-game-id="{{ p.game.id }}"
             data-external-id="{{ p.game.external_id }}">
            <div class="card-body p-3 md:p-4">
                
                <!-- Score Display -->
                <div class="flex flex-col md:flex-row items-stretch justify-between gap-0 relative">
                    <!-- Away Team -->
                    {% team_covered_spread p.game.away_team p.game lg.locked_home_spread as away_covered %}
                    <div class="flex items-center gap-2 md:gap-3 p-2 md:p-3 rounded-t-lg md:rounded-l-lg md:rounded-tr-none w-full md:w-auto md:flex-1 border-b md:border-b-0 md:border-r-2 border-base-300 {% if p.game.is_final and p.picked_team_id == p.game.away_team.id and p.is_correct %}bg-success/10 ring-4 ring-green-500 z-20{% elif p.game.is_final and p.picked_team_id != p.game.away_team.id and away_covered %}bg-error/10 ring-4 ring-red-500 z-20{% elif p.picked_team_id == p.game.away_team.id %}bg-primary/20 ring-2 ring-primary z-10{% else %}bg-base-200{% endif %}">
                        {% if p.game.away_team|team_logo_url %}
                        <img src="{% static p.game.away_team|team_logo_url %}" 
                             alt="{{ p.game.away_team.name }}" 
                             class="w-10 h-10 md:w-12 md:h-12 object-contain flex-shrink-0" />
                        {% endif %}
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-1 mb-1">
                                <span class="font-bold text-xs md:text-sm leading-tight">{{ p.game.away_team.name }}</span>
                                {% if p.game.away_team|team_won_game:p.game %}
                                    <i class="fas fa-trophy text-success text-xs" title="Winner"></i>
                                {% endif %}
                            </div>
                            <div class="flex items-center gap-1">
                                <div class="badge badge-ghost badge-xs">Away</div>
                                {% if away_covered %}
                                    <div class="badge badge-success badge-xs" title="Covered the spread">
                                        <i class="fas fa-check text-[8px]"></i>
                                    </div>
                                {% elif away_covered == False %}
                                    <div class="badge badge-error badge-xs" title="Did not cover">
                                        <i class="fas fa-times text-[8px]"></i>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <span class="text-2xl md:text-3xl font-bold flex-shrink-0" data-score="away">{{ p.game|display_score:"away" }}</span>
                    </div>
                    
                    <!-- Game Time/Status (CENTER) -->
                    <div class="flex flex-col items-center justify-center px-4 py-3 min-w-[120px] border-b md:border-b-0 md:border-r-2 border-base-300 bg-base-100 z-0" data-game-status>
                        {% if p.game.is_final %}
                            <div class="text-center">
                                <div class="text-2xl md:text-3xl font-bold text-success mb-1">FINAL</div>
                                <div class="text-xs text-base-content/60">{{ p.game.kickoff|eastern_time }}</div>
                            </div>
                        {% else %}
                            {% if p.game.quarter %}
                                <div class="text-center">
                                    <div class="text-xl md:text-2xl font-bold text-warning animate-pulse mb-1">
                                        Q{{ p.game.quarter }}
                                    </div>
                                    <div class="text-sm md:text-base font-semibold text-warning">{{ p.game.clock }}</div>
                                    <div class="text-xs text-base-content/60 mt-1">{{ p.game.kickoff|eastern_time }}</div>
                                </div>
                            {% else %}
                                <div class="text-center">
                                    {% if p.game.kickoff %}
                                        <div class="text-base md:text-lg font-semibold text-base-content/70 mb-1">{{ p.game.kickoff|eastern_time|default:p.game.kickoff }}</div>
                                        <div class="text-xs text-base-content/50">Scheduled</div>
                                    {% else %}
                                        <div class="text-base md:text-lg font-semibold text-base-content/50">Time TBD</div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endif %}
                        
                        <!-- Spread Information -->
                        {% if lg and lg.locked_home_spread is not None %}
                        <div class="text-center mt-2">
                            <div class="badge badge-secondary badge-sm">
                                <i class="fas fa-lock mr-1"></i>
                                {% with display_spread=lg.locked_home_spread|apply_hooks:league_rules.force_hooks %}
                                    {% if display_spread < 0 %}
                                        {{ p.game.home_team.abbreviation|default:p.game.home_team.name }} {{ display_spread|floatformat:1 }}
                                    {% elif display_spread > 0 %}
                                        {{ p.game.away_team.abbreviation|default:p.game.away_team.name }} -{{ display_spread|floatformat:1 }}
                                    {% else %}
                                        Pick 'Em
                                    {% endif %}
                                {% endwith %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Home Team -->
                    {% team_covered_spread p.game.home_team p.game lg.locked_home_spread as home_covered %}
                    <div class="flex items-center gap-2 md:gap-3 p-2 md:p-3 rounded-b-lg md:rounded-r-lg md:rounded-bl-none w-full md:w-auto md:flex-1 {% if p.game.is_final and p.picked_team_id == p.game.home_team.id and p.is_correct %}bg-success/10 ring-4 ring-green-500 z-20{% elif p.game.is_final and p.picked_team_id != p.game.home_team.id and home_covered %}bg-error/10 ring-4 ring-red-500 z-20{% elif p.picked_team_id == p.game.home_team.id %}bg-primary/20 ring-2 ring-primary z-10{% else %}bg-base-200{% endif %}">
                        {% if p.game.home_team|team_logo_url %}
                        <img src="{% static p.game.home_team|team_logo_url %}" 
                             alt="{{ p.game.home_team.name }}" 
                             class="w-10 h-10 md:w-12 md:h-12 object-contain flex-shrink-0" />
                        {% endif %}
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-1 mb-1">
                                <span class="font-bold text-xs md:text-sm leading-tight">{{ p.game.home_team.name }}</span>
                                {% if p.game.home_team|team_won_game:p.game %}
                                    <i class="fas fa-trophy text-success text-xs" title="Winner"></i>
                                {% endif %}
                            </div>
                            <div class="flex items-center gap-1">
                                <div class="badge badge-ghost badge-xs">Home</div>
                                {% if home_covered %}
                                    <div class="badge badge-success badge-xs" title="Covered the spread">
                                        <i class="fas fa-check text-[8px]"></i>
                                    </div>
                                {% elif home_covered == False %}
                                    <div class="badge badge-error badge-xs" title="Did not cover">
                                        <i class="fas fa-times text-[8px]"></i>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <span class="text-2xl md:text-3xl font-bold flex-shrink-0" data-score="home">{{ p.game|display_score:"home" }}</span>
                    </div>
                </div>
                
                <!-- Key Pick Indicator -->
                {% if p.is_key_pick %}
                <div class="flex justify-center items-center gap-3 mt-3">
                    <div class="badge badge-warning badge-sm md:badge-md gap-1">
                        <i class="fas fa-star"></i>
                        Key Pick
                    </div>
                </div>
                {% endif %}
                
            </div>
        </div>
                {% endwith %}
            {% endif %}
        {% endfor %}
    </div>
    
    <!-- Auto-refresh notice -->
    <div class="alert alert-info mt-6">
        <i class="fas fa-sync-alt mr-2 live-indicator"></i>
        <div>
            <p class="font-semibold">Live Score Updates Active</p>
            <p class="text-sm opacity-80">Scores refresh automatically every 5-30 seconds. No manual refresh needed!</p>
        </div>
    </div>
{% elif current_league %}
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body items-center text-center py-16">
            <i class="fas fa-clipboard-list text-6xl text-base-300 mb-4"></i>
            <h2 class="card-title text-2xl mb-2">No Picks Yet</h2>
            <p class="text-base-content/70 mb-6">You haven't made any picks for this week.</p>
            <a href="/picks/" class="btn btn-primary">
                <i class="fas fa-hand-pointer mr-2"></i>
                Make Your Picks
            </a>
        </div>
    </div>
{% else %}
    <!-- No league -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body items-center text-center py-16">
            <i class="fas fa-exclamation-triangle text-6xl text-warning mb-4"></i>
            <h2 class="card-title text-2xl mb-2">No League Selected</h2>
            <p class="text-base-content/70 mb-6 max-w-md">
                Join or create a league to view live games!
            </p>
            <a href="/leagues/" class="btn btn-primary">View Leagues</a>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/live-score-updater.js' %}?v=9"></script>
<script>
/**
 * Initialize Live Score Updates
 * 
 * This script automatically polls the /api/games endpoint and updates
 * scores in real-time without requiring page refreshes.
 */
(function() {
    'use strict';
    
    // Only initialize if we have games to track
    const gamesContainer = document.getElementById('games-container');
    if (!gamesContainer) {
        console.log('[LiveScores] No games container found, skipping auto-update');
        return;
    }
    
    // Check if LiveScoreUpdater class exists
    if (typeof LiveScoreUpdater === 'undefined') {
        console.error('[LiveScores] LiveScoreUpdater class not found');
        return;
    }
    
    // Initialize the updater
    try {
        const updater = new LiveScoreUpdater({
        apiEndpoint: '/api/games/',
        
        // Polling intervals (milliseconds)
        livePollInterval: 5000,     // 5 seconds when games are live
        normalPollInterval: 30000,  // 30 seconds when all games final/pregame
        hiddenPollInterval: 60000,  // 60 seconds when tab is hidden
        
        // Callbacks
        onUpdate: function(updatedGames) {
            // Show subtle notifications for score changes
            updatedGames.forEach(({ game, changes }) => {
                const scoreChanged = changes.some(c => 
                    c.type === 'home_score' || c.type === 'away_score'
                );
                if (scoreChanged) {
                    showScoreUpdateNotification(game);
                }
            });
        },
        
        onError: function(error, retryCount) {
            if (retryCount >= 3) {
                showConnectionWarning();
            }
        },
        
        onStatusChange: function({ hasLiveGames, liveGameCount }) {
            // Update page title to show live game count
            if (hasLiveGames) {
                document.title = `(${liveGameCount} Live) Live Games - CFB Pick'em`;
            } else {
                document.title = 'Live Games - CFB Pick\'em';
            }
        }
    });
    
    // Start the updater
    updater.start();
    
    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        updater.destroy();
    });
    
    // Pause updates when user is interacting with the page
    // (Optional: uncomment if you want to pause during interactions)
    /*
    let interactionTimer;
    document.addEventListener('scroll', function() {
        updater.pause();
        clearTimeout(interactionTimer);
        interactionTimer = setTimeout(() => updater.resume(), 2000);
    });
    */
    
    /**
     * Show a subtle notification when a score updates
     */
    function showScoreUpdateNotification(game) {
        // Find the game card
        const gameCard = document.querySelector(`[data-game-id="${game.id}"]`);
        if (gameCard) {
            // Add flash animation
            gameCard.classList.add('game-card-updated');
            setTimeout(() => {
                gameCard.classList.remove('game-card-updated');
            }, 1000);
        }
    }
    
    /**
     * Show connection warning
     */
    function showConnectionWarning() {
        const statusIndicator = document.getElementById('live-status-indicator');
        if (statusIndicator) {
            statusIndicator.innerHTML = `
                <div class="flex items-center gap-2 text-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span class="text-xs">Connection issues</span>
                </div>
            `;
        }
    }
    
    // Expose updater globally for debugging
    window.liveScoreUpdater = updater;
    
    console.log('[LiveScores] Auto-update active');
    
    } catch (error) {
        console.error('[LiveScores] Initialization error:', error);
    }
    
})();
</script>
{% endblock %}
