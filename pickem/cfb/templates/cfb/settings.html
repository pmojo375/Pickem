{% extends 'cfb/base.html' %}
{% load static %}
{% load cfb_tags %}

{% block title %}Settings - CFB Pick'em{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 class="text-4xl font-bold mb-2">
                <i class="fas fa-cog text-primary mr-2"></i>
                Admin Settings
            </h1>
            <p class="text-base-content/70">Manage games, spreads, and week settings</p>
        </div>
        
        <!-- League Selector -->
        {% if manageable_leagues.count > 1 %}
        <div class="form-control w-full md:w-auto">
            <select class="select select-bordered select-primary" onchange="window.location.href='?league_id=' + this.value">
                {% for league in manageable_leagues %}
                <option value="{{ league.id }}" {% if league.id == current_league.id %}selected{% endif %}>
                    {{ league.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% else %}
        <div class="badge badge-primary badge-lg">{{ current_league.name }}</div>
        {% endif %}
    </div>
</div>

{% if current_league %}

<!-- League Rules -->
<div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
        <h2 class="card-title">
            <i class="fas fa-gavel text-primary mr-2"></i>
            League Rules
        </h2>
        <p class="text-sm text-base-content/70 mb-4">Configure scoring, picking, and other rules for this league. Rules are season-specific.</p>
        
        {% if not active_season %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <span>No active season found. Please create a season first.</span>
        </div>
        {% else %}
        <form method="post" action="" id="league-rules-form">
            {% csrf_token %}
            <input type="hidden" name="do" value="save_league_rules" />
            <input type="hidden" name="league_id" value="{{ current_league.id }}" />
            <input type="hidden" name="season_id" value="{{ active_season.id }}" />
            
            <!-- Season Selector -->
            <div class="alert alert-info mb-4">
                <i class="fas fa-calendar-alt"></i>
                <div>
                    <div class="font-bold">Editing Rules for Season: {{ active_season.year }}</div>
                    <div class="text-sm">These rules apply only to the {{ active_season.year }} season</div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Points per Correct Pick -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">
                            <i class="fas fa-trophy text-warning mr-1"></i>
                            Points per Correct Pick
                        </span>
                    </label>
                    <input type="number" 
                           name="points_per_correct_pick" 
                           value="{{ league_rules.points_per_correct_pick }}" 
                           min="0"
                           class="input input-bordered" />
                    <label class="label">
                        <span class="label-text-alt text-base-content/60">Points awarded for each correct pick</span>
                    </label>
                </div>
                
                <!-- Key Pick Extra Points -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">
                            <i class="fas fa-star text-warning mr-1"></i>
                            Key Pick Extra Points
                        </span>
                    </label>
                    <input type="number" 
                           name="key_pick_extra_points" 
                           value="{{ league_rules.key_pick_extra_points }}" 
                           min="0"
                           class="input input-bordered" />
                    <label class="label">
                        <span class="label-text-alt text-base-content/60">Bonus points for correct key picks</span>
                    </label>
                </div>
                
                <!-- Against the Spread Enabled -->
                <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-4">
                        <input type="checkbox" 
                               name="against_the_spread_enabled" 
                               {% if league_rules.against_the_spread_enabled %}checked{% endif %}
                               class="checkbox checkbox-primary" />
                        <div>
                            <span class="label-text font-semibold">
                                <i class="fas fa-chart-line text-info mr-1"></i>
                                Enable Against the Spread
                            </span>
                            <p class="text-sm text-base-content/60">Games are scored against the spread</p>
                        </div>
                    </label>
                </div>
                
                <!-- Spread Lock Weekday -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">
                            <i class="fas fa-calendar text-info mr-1"></i>
                            Spread Lock Day (if ATS is enabled)
                        </span>
                    </label>
                    <select name="spread_lock_weekday" class="select select-bordered">
                        <option value="0" {% if league_rules.spread_lock_weekday == 0 %}selected{% endif %}>Monday</option>
                        <option value="1" {% if league_rules.spread_lock_weekday == 1 %}selected{% endif %}>Tuesday</option>
                        <option value="2" {% if league_rules.spread_lock_weekday == 2 %}selected{% endif %}>Wednesday</option>
                        <option value="3" {% if league_rules.spread_lock_weekday == 3 %}selected{% endif %}>Thursday</option>
                        <option value="4" {% if league_rules.spread_lock_weekday == 4 %}selected{% endif %}>Friday</option>
                        <option value="5" {% if league_rules.spread_lock_weekday == 5 %}selected{% endif %}>Saturday</option>
                        <option value="6" {% if league_rules.spread_lock_weekday == 6 %}selected{% endif %}>Sunday</option>
                    </select>
                    <label class="label">
                        <span class="label-text-alt text-base-content/60">Day when spreads lock in place</span>
                    </label>
                </div>
                
                <!-- Pickable Games per Week -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">
                            <i class="fas fa-football text-success mr-1"></i>
                            Pickable Games per Week
                        </span>
                    </label>
                    <input type="number" 
                           name="pickable_games_per_week" 
                           value="{{ league_rules.pickable_games_per_week }}" 
                           min="1"
                           class="input input-bordered" />
                    <label class="label">
                        <span class="label-text-alt text-base-content/60">Max games available for picking weekly</span>
                    </label>
                </div>
                
                <!-- Picks per Week -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">
                            <i class="fas fa-list-check text-primary mr-1"></i>
                            Required Picks per Week
                        </span>
                    </label>
                    <input type="number" 
                           name="picks_per_week" 
                           value="{{ league_rules.picks_per_week }}" 
                           min="0"
                           class="input input-bordered" />
                    <label class="label">
                        <span class="label-text-alt text-base-content/60">0 = must pick all available games</span>
                    </label>
                </div>
                
                <!-- Key Picks Enabled -->
                <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-4">
                        <input type="checkbox" 
                               name="key_picks_enabled" 
                               {% if league_rules.key_picks_enabled %}checked{% endif %}
                               class="checkbox checkbox-primary" />
                        <div>
                            <span class="label-text font-semibold">
                                <i class="fas fa-key text-warning mr-1"></i>
                                Enable Key Picks
                            </span>
                            <p class="text-sm text-base-content/60">Allow bonus key picks</p>
                        </div>
                    </label>
                </div>
                
                <!-- Number of Key Picks -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">
                            <i class="fas fa-hashtag text-warning mr-1"></i>
                            Key Picks per Week
                        </span>
                    </label>
                    <input type="number" 
                           name="number_of_key_picks" 
                           value="{{ league_rules.number_of_key_picks }}" 
                           min="0"
                           class="input input-bordered" />
                    <label class="label">
                        <span class="label-text-alt text-base-content/60">Number of key picks allowed weekly</span>
                    </label>
                </div>
            </div>
            
            <div class="card-actions justify-end mt-6">
                <button type="submit" class="btn btn-primary btn-lg gap-2">
                    <i class="fas fa-save"></i>
                    Save League Rules
                </button>
            </div>
        </form>
        {% endif %}
    </div>
</div>

<!-- Spread Locking Option -->
<div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
        <h2 class="card-title">
            <i class="fas fa-lock text-warning mr-2"></i>
            Spread Locking
        </h2>
        <div class="form-control">
            <label class="label cursor-pointer justify-start gap-4">
                <input type="checkbox" id="lock_spread_option" class="checkbox checkbox-warning" />
                <div>
                    <span class="label-text font-bold text-base">Lock spreads when selecting games</span>
                    <p class="text-sm text-base-content/70">When checked, saving game selections will lock the current spreads for those games.</p>
                </div>
            </label>
        </div>
    </div>
</div>

<!-- Games Selection -->
<div class="card bg-base-100 shadow-xl">
    <div class="card-body">
        <div class="mb-4">
            <h2 class="card-title flex-wrap gap-2">
                <span class="flex items-center">
                    <i class="fas fa-football text-primary mr-2"></i>
                    Games This Week
                </span>
                {% if league_rules and league_rules.pickable_games_per_week > 0 %}
                <div class="badge badge-info badge-lg whitespace-nowrap">
                    <i class="fas fa-info-circle mr-1"></i>
                    Limit: {{ league_rules.pickable_games_per_week }} games
                </div>
                {% endif %}
            </h2>
        </div>
        
        {% if games_with_selection %}
        <form method="post" action="" id="games-form">
            {% csrf_token %}
            <input type="hidden" name="do" value="save_selections" />
            <input type="hidden" name="league_id" value="{{ current_league.id }}" />
            <input type="hidden" name="lock_spread" value="" id="lock_spread_field" />
            
            <!-- Save All Button - Top -->
            <div class="mb-4">
                <button type="submit" class="btn btn-primary btn-lg w-full shadow-xl">
                    <i class="fas fa-save mr-2"></i>
                    Save Game Selections for {{ current_league.name }}
                </button>
            </div>
            
            <!-- Select Top 25 Button -->
            <div class="mb-4">
                <button type="button" id="select-top25-btn" class="btn btn-secondary btn-lg w-full shadow-xl">
                    <i class="fas fa-star mr-2"></i>
                    Select All AP Top 25 Games
                </button>
            </div>
            
            <div class="grid grid-cols-1 gap-3">
                {% for g, lg in games_with_selection %}
                <label class="game-card cursor-pointer" 
                       data-has-ranked="{% if g.home_team.id in team_rankings or g.away_team.id in team_rankings %}true{% else %}false{% endif %}"
                       data-home-rank="{% if g.home_team.id in team_rankings %}{{ team_rankings|get_item:g.home_team.id }}{% else %}999{% endif %}"
                       data-away-rank="{% if g.away_team.id in team_rankings %}{{ team_rankings|get_item:g.away_team.id }}{% else %}999{% endif %}">
                    <input type="checkbox" 
                           name="game_{{ g.id }}_select" 
                           class="game-checkbox hidden"
                           {% if lg %}checked{% endif %} />
                    <input type="hidden" name="game_{{ g.id }}_id" value="{{ g.id }}" />
                    
                    <div class="game-card-content flex flex-col md:flex-row items-start md:items-center gap-4 p-4 rounded-lg border-2 border-base-300 bg-base-200/50 hover:bg-base-200 transition-all">
                        <!-- Kickoff Time -->
                        <div class="flex-shrink-0">
                            <div class="badge badge-ghost">
                                <i class="fas fa-clock mr-1"></i>
                                {{ g.kickoff|eastern_time }}
                            </div>
                        </div>
                        
                        <!-- Away Team -->
                        <div class="flex items-center gap-2 flex-1">
                            {% if g.away_team|team_logo_url %}
                            <img src="{% static g.away_team|team_logo_url %}" 
                                 alt="{{ g.away_team.name }}" 
                                 class="w-8 h-8 object-contain" />
                            {% endif %}
                            <div class="flex items-center gap-2">
                                {% if g.away_team.id in team_rankings %}
                                <span class="badge badge-primary badge-sm font-bold">#{{ team_rankings|get_item:g.away_team.id }}</span>
                                {% endif %}
                                <span class="font-semibold text-sm md:text-base">{{ g.away_team.name }}</span>
                            </div>
                        </div>
                        
                        <!-- @ Symbol -->
                        <div class="hidden md:block flex-shrink-0">
                            <span class="text-base-content/50">@</span>
                        </div>
                        
                        <!-- Home Team -->
                        <div class="flex items-center gap-2 flex-1">
                            {% if g.home_team|team_logo_url %}
                            <img src="{% static g.home_team|team_logo_url %}" 
                                 alt="{{ g.home_team.name }}" 
                                 class="w-8 h-8 object-contain" />
                            {% endif %}
                            <div class="flex flex-col md:flex-row md:items-center gap-1">
                                <div class="flex items-center gap-2">
                                    {% if g.home_team.id in team_rankings %}
                                    <span class="badge badge-primary badge-sm font-bold">#{{ team_rankings|get_item:g.home_team.id }}</span>
                                    {% endif %}
                                    <span class="font-semibold text-sm md:text-base">{{ g.home_team.name }}</span>
                                </div>
                                {% if lg and lg.locked_home_spread is not None %}
                                <span class="badge badge-warning badge-sm gap-1">
                                    <i class="fas fa-lock text-xs"></i>
                                    {% if lg.locked_home_spread > 0 %}
                                        {{ g.home_team.abbreviation|default:g.home_team.name }} -{{ lg.locked_home_spread }}
                                    {% else %}
                                        {{ g.away_team.abbreviation|default:g.away_team.name }} -{{ lg.locked_away_spread|floatformat:1 }}
                                    {% endif %}
                                </span>
                                {% elif g.current_home_spread is not None %}
                                <span class="badge badge-secondary badge-sm">
                                    {% game_spread g %}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Selection Indicator -->
                        <div class="flex-shrink-0 ml-auto">
                            <div class="selection-indicator hidden">
                                <i class="fas fa-check-circle text-2xl text-success"></i>
                            </div>
                        </div>
                    </div>
                </label>
                {% endfor %}
            </div>
            
            <!-- Save All Button - Bottom -->
            <div class="mt-4">
                <button type="submit" class="btn btn-primary btn-lg w-full shadow-xl">
                    <i class="fas fa-save mr-2"></i>
                    Save All Game Selections
                </button>
            </div>
        </form>
        {% else %}
        <div class="text-center py-8">
            <i class="fas fa-inbox text-4xl text-base-300 mb-2"></i>
            <p class="text-base-content/70">No games found for this week.</p>
        </div>
        {% endif %}
    </div>
</div>
{% else %}
<!-- No league -->
<div class="card bg-base-100 shadow-xl">
    <div class="card-body items-center text-center py-16">
        <i class="fas fa-exclamation-triangle text-6xl text-warning mb-4"></i>
        <h2 class="card-title text-2xl mb-2">No League Selected</h2>
        <p class="text-base-content/70 mb-6 max-w-md">
            Create or select a league to manage game settings!
        </p>
        <a href="/leagues/" class="btn btn-primary">View Leagues</a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    /* Selected game card styling */
    .game-card input[type="checkbox"]:checked + input[type="hidden"] + .game-card-content {
        border-color: hsl(var(--p));
        background: linear-gradient(135deg, hsl(var(--p) / 0.2) 0%, hsl(var(--p) / 0.1) 100%);
        box-shadow: 0 0 0 3px hsl(var(--p) / 0.3);
    }
    
    /* Show check icon when selected */
    .game-card input[type="checkbox"]:checked + input[type="hidden"] + .game-card-content .selection-indicator {
        display: block !important;
    }
    
    /* Hover effect */
    .game-card:hover .game-card-content {
        transform: translateY(-2px);
    }
    
    /* Smooth transitions */
    .game-card-content {
        transition: all 0.3s ease;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
  // Sync the global lock spread checkbox with form submission
  document.addEventListener('DOMContentLoaded', function() {
    const lockSpreadCheckbox = document.getElementById('lock_spread_option');
    const gamesForm = document.getElementById('games-form');
    const lockSpreadField = document.getElementById('lock_spread_field');
    
    if (gamesForm) {
      gamesForm.addEventListener('submit', function(e) {
        lockSpreadField.value = lockSpreadCheckbox.checked ? 'on' : '';
      });
    }
    
    // Pick limit validation
    const pickLimit = {{ league_rules.pickable_games_per_week|default:0 }};
    const gameCheckboxes = document.querySelectorAll('.game-checkbox');
    const selectedCount = document.querySelectorAll('.game-checkbox:checked').length;
    
    // Update counter display
    function updateCounter() {
      const selected = document.querySelectorAll('.game-checkbox:checked').length;
      const counter = document.getElementById('selection-counter');
      if (counter) {
        counter.textContent = `${selected}/${pickLimit} games selected`;
        counter.className = selected > pickLimit ? 'badge badge-error mt-2 mb-4' : 'badge badge-success mt-2 mb-4';
      }
    }
    
    // Add counter display after the Top 25 button
    const selectTop25Btn = document.getElementById('select-top25-btn');
    if (selectTop25Btn && pickLimit > 0) {
      const counter = document.createElement('div');
      counter.id = 'selection-counter';
      counter.className = 'badge badge-success mt-2 mb-4';
      counter.textContent = `${selectedCount}/${pickLimit} games selected`;
      selectTop25Btn.parentNode.insertAdjacentElement('afterend', counter);
    }
    
    // Add validation to each checkbox
    gameCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const selected = document.querySelectorAll('.game-checkbox:checked').length;
        
        // If trying to select more than the limit, prevent it (only if limit > 0)
        if (this.checked && pickLimit > 0 && selected > pickLimit) {
          this.checked = false;
          
          // Show warning
          const warning = document.createElement('div');
          warning.className = 'alert alert-warning mt-2';
          warning.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <span>You can only select up to ${pickLimit} games for this league. Please deselect a game first.</span>
          `;
          
          // Remove any existing warnings
          const existingWarning = document.querySelector('.alert-warning');
          if (existingWarning) {
            existingWarning.remove();
          }
          
          // Add warning after the form
          const form = document.getElementById('games-form');
          if (form) {
            form.appendChild(warning);
            
            // Remove warning after 5 seconds
            setTimeout(() => {
              if (warning.parentNode) {
                warning.remove();
              }
            }, 5000);
          }
        }
        
        updateCounter();
      });
    });
    
    // Initial counter update
    updateCounter();
    
    // Handle "Select All AP Top 25 Games" button
    if (selectTop25Btn) {
      selectTop25Btn.addEventListener('click', function() {
        const rankedGameCards = Array.from(document.querySelectorAll('.game-card[data-has-ranked="true"]'));
        
        // Sort games by best rank (lowest number = highest rank)
        // Get the minimum rank from home and away teams
        rankedGameCards.sort((a, b) => {
          const aHomeRank = parseInt(a.dataset.homeRank) || 999;
          const aAwayRank = parseInt(a.dataset.awayRank) || 999;
          const aBestRank = Math.min(aHomeRank, aAwayRank);
          
          const bHomeRank = parseInt(b.dataset.homeRank) || 999;
          const bAwayRank = parseInt(b.dataset.awayRank) || 999;
          const bBestRank = Math.min(bHomeRank, bAwayRank);
          
          return aBestRank - bBestRank;
        });
        
        let selectedCount = 0;
        let skippedCount = 0;
        let totalRankedGames = rankedGameCards.length;
        
        // First, count how many are already selected
        let alreadySelected = 0;
        rankedGameCards.forEach(card => {
          const checkbox = card.querySelector('.game-checkbox');
          if (checkbox && checkbox.checked) {
            alreadySelected++;
          }
        });
        
        // Now select games in rank order
        rankedGameCards.forEach(card => {
          const checkbox = card.querySelector('.game-checkbox');
          if (checkbox && !checkbox.checked) {
            // Check if adding this would exceed the limit
            const currentlySelected = document.querySelectorAll('.game-checkbox:checked').length;
            if (pickLimit > 0 && currentlySelected >= pickLimit) {
              skippedCount++;
              return;
            }
            checkbox.checked = true;
            selectedCount++;
          }
        });
        
        updateCounter();
        
        // Show feedback message
        const feedback = document.createElement('div');
        
        if (selectedCount === 0 && alreadySelected === totalRankedGames) {
          feedback.className = 'alert alert-info mt-2';
          feedback.innerHTML = `
            <i class="fas fa-info-circle"></i>
            <span>All ${totalRankedGames} AP Top 25 game${totalRankedGames !== 1 ? 's are' : ' is'} already selected!</span>
          `;
        } else if (selectedCount === 0 && pickLimit > 0) {
          feedback.className = 'alert alert-warning mt-2';
          feedback.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <span>Pick limit reached. Cannot select more games.</span>
          `;
        } else if (selectedCount > 0 && skippedCount === 0) {
          feedback.className = 'alert alert-success mt-2';
          feedback.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <span>Selected ${selectedCount} AP Top 25 game${selectedCount !== 1 ? 's' : ''} (prioritized by ranking)!</span>
          `;
        } else if (selectedCount > 0 && skippedCount > 0) {
          feedback.className = 'alert alert-success mt-2';
          feedback.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <span>Selected top ${selectedCount} AP Top 25 game${selectedCount !== 1 ? 's' : ''} by ranking. ${skippedCount} lower-ranked game${skippedCount !== 1 ? 's' : ''} skipped due to pick limit.</span>
          `;
        } else {
          feedback.className = 'alert alert-info mt-2';
          feedback.innerHTML = `
            <i class="fas fa-info-circle"></i>
            <span>No additional games selected.</span>
          `;
        }
        
        // Remove existing feedback
        const existingFeedback = document.querySelector('.top25-feedback');
        if (existingFeedback) {
          existingFeedback.remove();
        }
        
        feedback.classList.add('top25-feedback');
        selectTop25Btn.parentNode.insertAdjacentElement('afterend', feedback);
        
        // Remove feedback after 5 seconds
        setTimeout(() => {
          if (feedback.parentNode) {
            feedback.remove();
          }
        }, 5000);
      });
    }
  });
</script>
{% endblock %}
