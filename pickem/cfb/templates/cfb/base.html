<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CFB Pick'em{% endblock %}</title>
    
    <!-- Tailwind CSS + DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #5a6678;
        }
        
        /* Smooth transitions */
        * {
            transition: background-color 0.2s ease;
        }
        
        /* Flexbox layout for sticky footer */
        html {
            height: 100%;
        }
        
        body {
            min-height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .main-content {
            flex: 1 0 auto;
        }
        
        footer {
            flex-shrink: 0;
        }
        
        /* App-like bottom nav for mobile */
        @media (max-width: 768px) {
            .bottom-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 50;
            }
            .main-content {
                padding-bottom: 100px !important;
            }
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-base-300">
    <!-- Desktop Navigation -->
    <div class="navbar bg-base-100 shadow-lg sticky top-0 z-50 hidden md:flex">
        <div class="navbar-start">
            <a href="/" class="btn btn-ghost text-xl">
                <i class="fas fa-football text-primary"></i>
                <span class="ml-2 bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent font-bold">CFB Pick'em</span>
            </a>
        </div>
        <div class="navbar-center hidden lg:flex">
            <ul class="menu menu-horizontal px-1 gap-1">
                <li><a href="/" class="{% if request.path == '/' %}active{% endif %}"><i class="fas fa-home mr-1"></i> Home</a></li>
                <li><a href="/picks/" class="{% if request.path == '/picks/' %}active{% endif %}"><i class="fas fa-hand-pointer mr-1"></i> Picks</a></li>
                <li><a href="/live/" class="{% if request.path == '/live/' %}active{% endif %}"><i class="fas fa-play-circle mr-1"></i> Live</a></li>
                <li><a href="/standings/" class="{% if request.path == '/standings/' %}active{% endif %}"><i class="fas fa-trophy mr-1"></i> Standings</a></li>
                <li><a href="/leagues/" class="{% if '/leagues/' in request.path %}active{% endif %}"><i class="fas fa-users-cog mr-1"></i> Leagues</a></li>
                <li><a href="/roster/" class="{% if request.path == '/roster/' %}active{% endif %}"><i class="fas fa-users mr-1"></i> Roster</a></li>
                {% if request.user.is_staff %}
                <li><a href="/settings/" class="{% if request.path == '/settings/' %}active{% endif %}"><i class="fas fa-cog mr-1"></i> Settings</a></li>
                {% endif %}
            </ul>
        </div>
        <div class="navbar-end">
            {% if request.user.is_authenticated %}
                <div class="dropdown dropdown-end">
                    <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar placeholder">
                        <div class="bg-primary text-primary-content rounded-full w-10">
                            <span class="text-xl">{{ request.user.username|slice:":1"|upper }}</span>
                        </div>
                    </div>
                    <ul tabindex="0" class="mt-3 z-[1] p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52">
                        <li class="menu-title">
                            <span>{{ request.user.username }}</span>
                        </li>
                        <li><a href="{% url 'socialaccount_connections' %}"><i class="fas fa-link mr-1"></i> Connected Accounts</a></li>
                        <li><a href="{% url 'account_logout' %}"><i class="fas fa-sign-out-alt mr-1"></i> Logout</a></li>
                    </ul>
                </div>
            {% else %}
                <a href="{% url 'account_login' %}" class="btn btn-primary btn-sm">
                    <i class="fas fa-sign-in-alt mr-1"></i> Login
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <div class="btm-nav btm-nav-md md:hidden bottom-nav bg-base-100 border-t border-base-300">
        <a href="/" class="{% if request.path == '/' %}active text-primary{% endif %}">
            <i class="fas fa-home text-lg"></i>
            <span class="btm-nav-label text-xs">Home</span>
        </a>
        <a href="/picks/" class="{% if request.path == '/picks/' %}active text-primary{% endif %}">
            <i class="fas fa-hand-pointer text-lg"></i>
            <span class="btm-nav-label text-xs">Picks</span>
        </a>
        <a href="/live/" class="{% if request.path == '/live/' %}active text-primary{% endif %}">
            <i class="fas fa-play-circle text-lg"></i>
            <span class="btm-nav-label text-xs">Live</span>
        </a>
        <a href="/standings/" class="{% if request.path == '/standings/' %}active text-primary{% endif %}">
            <i class="fas fa-trophy text-lg"></i>
            <span class="btm-nav-label text-xs">Standings</span>
        </a>
        <a href="/leagues/" class="{% if '/leagues/' in request.path %}active text-primary{% endif %}">
            <i class="fas fa-users-cog text-lg"></i>
            <span class="btm-nav-label text-xs">Leagues</span>
        </a>
    </div>

    <!-- Mobile Header (shows user info) -->
    <div class="navbar bg-base-100 shadow-lg sticky top-0 z-50 md:hidden">
        <div class="navbar-start">
            <a href="/" class="btn btn-ghost text-lg">
                <i class="fas fa-football text-primary"></i>
                <span class="ml-2 bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent font-bold">CFB Pick'em</span>
            </a>
        </div>
        <div class="navbar-end">
            {% if request.user.is_authenticated %}
                <div class="dropdown dropdown-end">
                    <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar placeholder">
                        <div class="bg-primary text-primary-content rounded-full w-8">
                            <span class="text-sm">{{ request.user.username|slice:":1"|upper }}</span>
                        </div>
                    </div>
                    <ul tabindex="0" class="mt-3 z-[1] p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52">
                        <li class="menu-title">
                            <span>{{ request.user.username }}</span>
                        </li>
                        {% if request.user.is_staff %}
                        <li><a href="/settings/"><i class="fas fa-cog mr-1"></i> Settings</a></li>
                        {% endif %}
                        <li><a href="{% url 'socialaccount_connections' %}"><i class="fas fa-link mr-1"></i> Connected Accounts</a></li>
                        <li><a href="{% url 'account_logout' %}"><i class="fas fa-sign-out-alt mr-1"></i> Logout</a></li>
                    </ul>
                </div>
            {% else %}
                <a href="{% url 'account_login' %}" class="btn btn-primary btn-sm">Login</a>
            {% endif %}
        </div>
    </div>

    <!-- Main Content Wrapper for Flex Layout -->
    <div class="main-content">
        <!-- Messages/Alerts -->
        {% if messages %}
        <div class="container mx-auto px-4 mt-4 max-w-7xl">
            {% for message in messages %}
            <div role="alert" class="alert {% if message.tags == 'error' %}alert-error{% elif message.tags == 'success' %}alert-success{% elif message.tags == 'warning' %}alert-warning{% else %}alert-info{% endif %} mb-2">
                <i class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'success' %}fa-check-circle{% elif message.tags == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %}"></i>
                <span>{{ message }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-6 max-w-7xl pb-6">
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Footer -->
    <footer class="footer footer-center p-4 bg-base-100 text-base-content mt-auto hidden md:block">
        <aside>
            <p>¬© 2024 CFB Pick'em - Built for the love of college football üèà</p>
        </aside>
    </footer>

    {% block extra_js %}{% endblock %}
    
    <script>
    /**
     * League Selection Persistence
     * Remembers the user's selected league across page navigations
     */
    (function() {
        'use strict';
        
        const LEAGUE_STORAGE_KEY = 'cfb_pickem_selected_league_id';
        
        // Function to save league selection to localStorage
        function saveLeagueSelection(leagueId) {
            if (leagueId) {
                localStorage.setItem(LEAGUE_STORAGE_KEY, leagueId);
            }
        }
        
        // Function to get saved league selection from localStorage
        function getSavedLeagueSelection() {
            return localStorage.getItem(LEAGUE_STORAGE_KEY);
        }
        
        // Function to handle league dropdown change
        function handleLeagueChange(selectElement) {
            const leagueId = selectElement.value;
            if (leagueId) {
                saveLeagueSelection(leagueId);
                
                // Get current URL and update league_id parameter
                const url = new URL(window.location);
                url.searchParams.set('league_id', leagueId);
                window.location.href = url.toString();
            }
        }
        
        // Function to update navigation links to preserve league_id
        function updateNavigationLinks(leagueId) {
            if (!leagueId) return;
            
            // Pages that should preserve league_id
            const leaguePages = ['/', '/picks/', '/live/', '/standings/', '/roster/', '/settings/'];
            
            // Find all navigation links
            const navLinks = document.querySelectorAll('.navbar a[href], .btm-nav a[href]');
            
            navLinks.forEach(function(link) {
                const href = link.getAttribute('href');
                if (!href) return;
                
                // Check if this is a league-related page
                const isLeaguePage = leaguePages.some(function(page) {
                    return href === page || href.startsWith(page + '?');
                });
                
                if (isLeaguePage) {
                    try {
                        const url = new URL(href, window.location.origin);
                        // Only update if league_id is not already set
                        if (!url.searchParams.has('league_id')) {
                            url.searchParams.set('league_id', leagueId);
                            link.setAttribute('href', url.pathname + url.search);
                        }
                    } catch (e) {
                        // If URL parsing fails, skip this link
                        console.warn('Failed to parse URL:', href, e);
                    }
                }
            });
        }
        
        // Attach handlers to all league dropdowns on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Find all league selector dropdowns
            const leagueSelectors = document.querySelectorAll('select[onchange*="league_id"]');
            
            leagueSelectors.forEach(function(select) {
                // Remove inline onchange handler
                const oldOnchange = select.getAttribute('onchange');
                select.removeAttribute('onchange');
                
                // Add event listener
                select.addEventListener('change', function() {
                    handleLeagueChange(this);
                });
            });
            
            // Check if we need to redirect to include saved league_id
            const urlParams = new URLSearchParams(window.location.search);
            const currentLeagueId = urlParams.get('league_id');
            const savedLeagueId = getSavedLeagueSelection();
            
            // Only redirect if:
            // 1. We have a saved league_id
            // 2. Current URL doesn't have a league_id parameter
            // 3. We're on a page that uses league selection (not on leagues list or detail pages)
            const path = window.location.pathname;
            const shouldUseLeagueSelection = !path.includes('/leagues/') && 
                                            !path.includes('/league/') &&
                                            path !== '/login/' &&
                                            path !== '/logout/' &&
                                            path !== '/accounts/';
            
            if (shouldUseLeagueSelection && savedLeagueId && !currentLeagueId) {
                // Redirect to include the saved league_id
                const url = new URL(window.location);
                url.searchParams.set('league_id', savedLeagueId);
                window.location.href = url.toString();
                return; // Exit early to prevent further execution
            }
            
            // Determine which league_id to use (current URL or saved)
            const activeLeagueId = currentLeagueId || savedLeagueId;
            
            // If we have a league_id in URL, save it
            if (currentLeagueId) {
                saveLeagueSelection(currentLeagueId);
            }
            
            // Update navigation links to preserve league_id
            if (activeLeagueId) {
                updateNavigationLinks(activeLeagueId);
            }
        });
    })();
    </script>
</body>
</html>

